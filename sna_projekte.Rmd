---
title: "Soziale Netzwerkanalyse: Projekte"
author: "Jonas Geschke"
date: "2018"
header-includes:
   - \usepackage{longtable}
output:
  pdf_document:
    toc: yes
  documentclass: article
  html_document:
    toc: yes
  classoption: a4paper
  graphics: yes
---

# Einleitung
Dieses ist das Skript der Netzwerkanalyse zu NeFo auf Grundlage der von DFG und der verschiedenen Bundesressorts geförderten Projekte. Das Skrpit ist verfügbar unter https://github.com/JonasGeschke/nefo
Die Netzwerkanalyse selbst ist verfügbar unter XXX


# Einstellungen

```{r set wd - CHOOSE, eval=FALSE}
# If your working directory is not already specified because you are running this
# script within a project, you will need to use the setwd() function below to set
# the path of your working directory. In order to do this just copy the path
# between the quote signs.
# Please note: The different levels of the path need to be separated by slashes
# ("/"), not by backslashes ("\") which are the windows default.
# 
# setwd("")

#setwd("/Volumes/NO NAME/MfN/Netzwerkanalyse_Projekte/R") # Stick
setwd("Z:/Benutzer/Jonas.Geschke/Netzwerkanalyse_Projekte/R") # Buero
```

```{r install packages, eval=FALSE}
# Installing required packages if not installed yet
if("statnet" %in% rownames(installed.packages())   == FALSE){
  install.packages("statnet")}
if("network" %in% rownames(installed.packages())   == FALSE){
  install.packages("network")}
if("sna" %in% rownames(installed.packages())   == FALSE){
  install.packages("sna")}
if("igraph" %in% rownames(installed.packages())   == FALSE){
  install.packages("igraph")}
if("xts" %in% rownames(installed.packages())   == FALSE){
  install.packages("xts")}
if("xlsx" %in% rownames(installed.packages())   == FALSE){
  install.packages("xlsx")}
if("dplyr" %in% rownames(installed.packages())   == FALSE){
  install.packages("dplyr")}
if("rgl" %in% rownames(installed.packages())   == FALSE){
  install.packages("rgl")}
if("extrafont" %in% rownames(installed.packages())   == FALSE){
  install.packages("extrafont")}
if("circlize" %in% rownames(installed.packages())   == FALSE){
  install.packages("circlize")}
if("RColorBrewer" %in% rownames(installed.packages())   == FALSE){
  install.packages("RColorBrewer")}
if("lubridate" %in% rownames(installed.packages())   == FALSE){
  install.packages("lubridate")}
if("Rcrawler" %in% rownames(installed.packages())   == FALSE){
  install.packages("Rcrawler")}
```

```{r set additional functions, eval=FALSE}
as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}

'%!in%' <- function(x,y)!('%in%'(x,y))

subset_projects <- function(keywords = c(keywords), database = projects){

projects <- database
projects_filter <- projects
projects_filter$filter <- tolower(paste(projects_filter$Thema,
                                        projects_filter$Verbundprojekt,
                                        projects_filter$Klartext.Leistungsplansystematik,
                                        sep = "_"))

biodiv <- projects_filter[-c(1:nrow(projects_filter)),]
keywords_num <- c(1:length(keywords))
for(k in keywords_num){
biodiv <- rbind(biodiv,
                projects_filter[grep(keywords[k], projects_filter$filter),])
}
rm(projects_filter, k, keywords_num)

biodiv <- biodiv[order(biodiv$Ressort, 
                       strptime(biodiv$Laufzeit.von,format="%d.%m.%Y"), 
                       biodiv$Verbundprojekt, 
                       biodiv$Thema),]
duplicated_test <- integer(0)
if(identical(which(duplicated(biodiv)), duplicated_test) == FALSE){
  biodiv <- biodiv[-which(duplicated(biodiv)),]}
rm(duplicated_test)

inst_ids <- data.frame(unique = unique(biodiv$Zuwendungsempfänger),
                      id = as.character(paste("inst", c(1:length(unique(biodiv$Zuwendungsempfänger))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv))
nrows <- c(1:nrow(inst_ids))
for(n in nrow){
  for (s in nrows){
    if(biodiv[n,9] == inst_ids[s,1]){
       biodiv[n,8] <- inst_ids[s,2]}
    else{}
}}
rm(inst_ids, nrow, nrows, n, s)

biodiv_einzeln <- subset(biodiv, is.na(biodiv$Verbundprojekt))
biodiv_verbund <- subset(biodiv, !is.na(biodiv$Verbundprojekt))
biodiv_einzeln$unique <- paste(biodiv_einzeln$Laufzeit.von, biodiv_einzeln$Thema, sep = "_")
biodiv_verbund$unique <- paste(biodiv_verbund$Laufzeit.von, biodiv_verbund$Verbundprojekt, sep = "_")
proj_id <- data.frame(unique = unique(biodiv_verbund$unique),
                      id = as.character(paste("proj", c(1:length(unique(biodiv_verbund$unique))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_verbund))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_verbund[n,18] == proj_id[s,1]){
       biodiv_verbund[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
proj_id <- data.frame(unique = unique(biodiv_einzeln$unique),
                      id = as.character(
                        paste("proj", 
                              c((length(unique(biodiv_verbund$unique))+1):
                                (length(unique(biodiv_einzeln$unique))+length(unique(biodiv_verbund$unique)))
                                 ), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_einzeln))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_einzeln[n,18] == proj_id[s,1]){
       biodiv_einzeln[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
biodiv <- rbind(biodiv_verbund, biodiv_einzeln)
rm(biodiv_einzeln, biodiv_verbund)
biodiv <- biodiv[,-c(17,18)]

return(biodiv)
}

subset_förderzeitraum <- function(years = c(years), dataset = Gdata){

Gdata <- dataset

Gdata$Förderjahre <- NA
Gdata <- Gdata[,c(1:2,17,3:16)]

jahre <- c(as.numeric(format(as.Date(Gdata$Laufzeit.bis, "%d.%m.%Y"), "%Y")) - 
             as.numeric(format(as.Date(Gdata$Laufzeit.von, "%d.%m.%Y"), "%Y")))
nrow <- c(1:nrow(Gdata))

for(n in nrow){
  p <- 1
  period <- c(seq(from = as.numeric(format(as.Date(Gdata[n,4], "%d.%m.%Y"), "%Y")), 
                        length.out = (jahre[n]+1)))
  period_num <- c(1:length(period))
  Gdata[n,3] <- paste(period, collapse = "_")
}
rm(jahre, nrow, n, p, period, period_num)

if(years == "all"){
  Gdata_new <- Gdata}
else{
Gdata_new <- Gdata[-c(1:nrow(Gdata)),]
years_num <- c(1:length(years))
for(y in years_num){
Gdata_new <- rbind(Gdata_new,
                   Gdata[grep(as.character(years[y]), Gdata$Förderjahre),])
}
rm(y, years_num, Gdata)

duplicated_test <- integer(0)
if(identical(which(duplicated(Gdata_new)), duplicated_test) == FALSE){
  Gdata_new <- Gdata_new[-which(duplicated(Gdata_new)),]}
rm(duplicated_test)
}

return(Gdata_new)
}
```


# Analyse

```{r Crawling GEPRIS, eval=FALSE}
library(Rcrawler)

Suche <- "http://gepris.dfg.de/gepris/OCTOPUS?context=projekt&findButton=Finden&keywords_criterion=biodiv*+OR+%26quot%3Bbiologische+vielfalt%26quot%3B+OR+%26quot%3Bbiologischen+vielfalt%26quot%3B+OR+%26quot%3Bbiological+diversity%26quot%3B+OR+%26quot%3Bmonitoring%26quot%3B&language=de&nurProjekteMitAB=false&task=doSearchSimple"

keywords <- # * = und Anhang | +OR+ = OR | + = Leerzeichen | %26quot%3B = Anführungsstriche
Suche <- paste("http://gepris.dfg.de/gepris/OCTOPUS?context=project&findButton=Finden&keywords_criterion=", keywords, "&language=de&nurProjekteMitAB=false&task=doSearchSimple")
Rcrawler(Suche, no_cores = 4, no_conn = 4, MaxDepth = 1,
         dataUrlfilter = "/gepris/projekt/",
         ExtractCSSPat = c(".details > h3:nth-child(1)", # Titel
                           ".details > div:nth-child(2) > span:nth-child(2)", # Antragsteller
                           ".firstUnderAntragsbeteiligte > span:nth-child(2)", # Fachliche Zuordnung
                           ".details > div:nth-child(4) > span:nth-child(2)", # Förderzeitraum
                           ".projektnummer > span:nth-child(2)", # Projektnummer
                           "#projekttext", # Beschreibung
                           "#projektbeschreibung > div:nth-child(2) > span:nth-child(2)", # DFG-Verfahren
                           "#projektbeschreibung > div:nth-child(3) > span:nth-child(2) > a:nth-child(1)" # Verbundprojekt
                           ),
         PatternsNames = c("Titel",
                           "Antragsteller",
                           "Fachliche_Zuordnung",
                           "Förderzeitraum",
                           "Projektnummer",
                           "Beschreibung",
                           "DFG_Verfahren",
                           "Verbundprojekt")
         )
gepris <- data.frame(do.call("rbind", DATA))

Rcrawler("http://www.biodiversity.de", no_cores = 4, no_conn = 4 , NetworkData = TRUE, NetwExtLinks =TRUE,  statslinks = TRUE)
network <- graph.data.frame(NetwEdges, directed=T)
plot(network, vertex.size = 3, vertex.color = "dark grey", 
     vertex.label.family = "Calibri", vertex.label.cex = 0.5,
     vertex.frame.color = NA, vertex.label.color = "black",
     edge.arrow.size = 0.5)
```


```{r Laden der Rohdaten und Vorbereitung der Daten: PROJEKTE, eval=FALSE}
library(xlsx)
## Load raw data
#Raw_projects_FA <- read.csv2("Daten/Suchergebnisse_FA_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
#Raw_projects_FB <- read.csv2("Daten/Suchergebnisse_FB_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
#Raw_projects_FC <- read.csv2("Daten/Suchergebnisse_FC_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
#Raw_projects_FD <- read.csv2("Daten/Suchergebnisse_FD_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)

Raw_projects_gesamt <- read.csv2("Daten/Suchliste_gesamt_form.csv", sep=";", dec=",", header=T, na.strings = "", stringsAsFactors=F) # Abgerufen am 9.1.19

#projects <- rbind(Raw_projects_FA, Raw_projects_FB, Raw_projects_FC, Raw_projects_FD)
projects <- Raw_projects_gesamt

projects <- projects[,-c(1,3,5,7,8,9,10,13,14,15,16)]
projects <- projects[complete.cases(projects[,c(1:3)]),]
projects$inst_id <- NA
projects$proj_id <- NA
projects <- projects[,c(1,2,10,11,16,7,14,15,3,4,5,6,13,9,8,12)]

projects <- projects[order(projects$Ressort, projects$Laufzeit.von, projects$Laufzeit.bis),]

# Korrektur der Fraunhofer-Gesellschaft
#projects <- subset(projects, projects$Zuwendungsempfänger == "Fraunhofer-Gesellschaft zur Förderung der angewandten Forschung e.V.")
nrow <- c(1:nrow(projects))
for(n in nrow){
  if(projects[n,9] == "Fraunhofer-Gesellschaft zur Förderung der angewandten Forschung e.V."){
    projects[n,9] <- projects[n,11]
  }
}
rm(nrow, n)

abbr <- read.csv2("Forschungsatlas_abbr.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
abbr <- read.csv2("kuerzel_Donnerstag.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
abbr <- abbr[,-1]

kuerzel <- data.frame(abbr = NA, inst = unique(Gdata$Zuwendungsempfänger))
nrow_kuerzel <- c(1:nrow(kuerzel))
nrow_abbr <- c(1:nrow(abbr))
for(i in nrow_kuerzel){
  for(j in nrow_abbr){
    if(kuerzel[i,2] == abbr[j,2]){
      kuerzel[i,1] <- abbr[j,3]
    }
  }
}
rm(nrow_kuerzel, nrow_abbr, abbr)
#write.csv2(kuerzel, file = "kuerzel.csv")
```

```{r Analyse des Leistungsplans, eval=FALSE}
leistungsplan <- projects[,c(14,15)]
leistungsplan <- leistungsplan[-which(duplicated(leistungsplan)),]
leistungsplan <- leistungsplan[-which(is.na(leistungsplan$Klartext.Leistungsplansystematik)),]
leistungsplan <- leistungsplan[order(leistungsplan$Leistungsplansystematik),]

library(tidytext)
library(textreadr)
library(dplyr)
library(tidyr)

stopwords_de <- get_stopwords(language = "de")

lplan_df <- data_frame(line = 1:nrow(leistungsplan), text = leistungsplan$Klartext.Leistungsplansystematik)
tidy_lplan <- lplan_df %>% unnest_tokens(word, text, to_lower = T) %>% anti_join(get_stopwords(language = "de"))
tidy_lplan <- tidy_lplan[-which(duplicated(tidy_lplan)),]
tidy_lplan$document <- "lplan"
lplan <- tidy_lplan %>% count(word, sort = TRUE)

# Load NBS
NBS_raw <- read_document("Daten/nbs_plaintext.docx")
NBS_df <- data_frame(line = 1:length(NBS_raw), text = NBS_raw)
tidy_NBS <- NBS_df %>% unnest_tokens(word, text, to_lower = T) %>% anti_join(get_stopwords(language = "de"))
tidy_NBS$document <- "NBS"
NBS <- tidy_NBS %>% count(word, sort = TRUE)

# Load NSO
NSO_raw <- read_document("Daten/nso_plaintext.docx")
NSO_df <- data_frame(line = 1:length(NSO_raw), text = NSO_raw)
tidy_NSO <- NSO_df %>% unnest_tokens(word, text, to_lower = T) %>% anti_join(get_stopwords(language = "de"))
tidy_NSO$document <- "NSO"
NSO <- tidy_NSO %>% count(word, sort = TRUE)

rm(lplan_df, NBS_df, NSO_df, NBS_raw, NSO_raw, tidy_lplan, tidy_NBS, tidy_NSO, stopwords_de)
# Match Strategies with Leistungsplan
lplan$NBS <- NA
lplan$NSO <- NA

nrow_lplan <- c(1:nrow(lplan))
nrow_nbs <- c(1:nrow(NBS))
nrow_nso <- c(1:nrow(NSO))
for(n in nrow_lplan){
  for(b in nrow_nbs){
    if(lplan[n,1] == NBS[b,1]){
      lplan[n,3] <- NBS[b,2]
    }
  }
  for(o in nrow_nso){
    if(lplan[n,1] == NSO[o,1]){
      lplan[n,4] <- NBS[o,2]
    }
  }
}
rm(nrow_lplan, nrow_nbs, nrow_nso, n, b, o)

write.csv2(lplan, file = "leistungsplan_stichworte.csv")

lplan_cut <- lplan[-which(is.na(lplan$NBS) & is.na(lplan$NSO)),]
write.csv2(lplan_cut, file = "leistungsplan_stichworte_strategien.csv")
```

```{r subset by keywords, eval=FALSE}
biodiv <- subset_projects(keywords = c("biodiv"))
biodivbiolvielfalt <- subset_projects(keywords = c("biodiv", 
                                                   "biologische vielfalt", "biologischen vielfalt",
                                                   "biological diversity"))

monitoring <- subset_projects(keywords = c("biodiv", "biologische vielfalt", "biologischen vielfalt",
                                           "biological diversity", "monitoring"))

```

```{r Auswahl Datensatz und Förderzeitraum, eval=FALSE}
Gdata <- subset_förderzeitraum(years = c("all"), dataset = biodivbiolvielfalt)
Gdata <- subset_förderzeitraum(years = c(2019), dataset = biodivbiolvielfalt)

Gdata <- subset_förderzeitraum(years = c(2019), dataset = monitoring)
Gdata <- Gdata[-which(Gdata$Klartext.Leistungsplansystematik %in% c("Monitoring")),]#, 
                                                                    "Mensch-Technik-Interaktion für den demografischen Wandel (abgeschlossen)")),] # medical images

```


# Ergänzung durch Forschungsverbünde

```{r Laden der Rohdaten und Vorbereitung der Daten, eval=FALSE}
## Load raw data
Raw_forschungsnetzwerke <- read.csv2("Daten/forschungsnetzwerk.csv", sep=",", dec=".", header=T, encoding="UTF-8")

## Prepare dataset "FN"
Gdata_FN <- Raw_forschungsnetzwerke
names(Gdata_FN) <- c("inst", "abbr", "BeGenDiv", "BBIB", "BioFrankfurt", "BION", "iDiv", "Ecornet", "FVB", "GBIF-D", "GFBIO", "HIFMB", "KDM", "LVB")
Gdata_FN <- Gdata_FN[,-c(7,9,10,11)] #Delete iDiv, FVB, GBIF-D, GFBIO
rownames(Gdata_FN) <- Gdata_FN[,2] #Inst oder abbr as rownames
Gdata_FN <- Gdata_FN[,-c(1,2)] #Delete inst and abbr
Gdata_FN <- Gdata_FN[,c(8,4,2,7,3,5,1,6)] #Order by number of members

Gdata_FN$BeGenDiv <- as.numeric(Gdata_FN$BeGenDiv)
Gdata_FN$BBIB <- as.numeric(Gdata_FN$BBIB) #raus?
Gdata_FN$BioFrankfurt <- as.numeric(Gdata_FN$BioFrankfurt)
Gdata_FN$BION <- as.numeric(Gdata_FN$BION)
Gdata_FN$iDiv <- as.numeric(Gdata_FN$iDiv) #raus
Gdata_FN$Ecornet <- as.numeric(Gdata_FN$Ecornet)
Gdata_FN$GFBIO <- as.numeric(Gdata_FN$GFBIO) #raus
Gdata_FN$HIFMB <- as.numeric(Gdata_FN$HIFMB)
Gdata_FN$KDM <- as.numeric(Gdata_FN$KDM)
Gdata_FN$LVB <- as.numeric(Gdata_FN$LVB)
Gdata_FN$`GBIF-D` <- as.numeric(Gdata_FN$`GBIF-D`) #raus
```


# Netzwerkanalyse

```{r Vorbereitung, eval=FALSE}
inst <- data.frame(id = Gdata$inst_id,
                   abbr = NA,
                   name = Gdata$Zuwendungsempfänger,
                   type = "Institution",
                   ressort = NA,
                   pt = NA,
                   leistungsplansystematik = NA,
                   budget = NA,
                   stringsAsFactors = FALSE)
proj <- data.frame(id = Gdata$proj_id,
                   abbr = NA,
                   name = Gdata$Thema,
                   type = "Projekt",
                   ressort = Gdata$Ressort,
                   pt = Gdata$PT,
                   leistungsplansystematik = Gdata$Klartext.Leistungsplansystematik,
                   budget = NA,
                   stringsAsFactors = FALSE)
nodes <- rbind(inst,proj)
nodes <- nodes[-which(duplicated(nodes$id)),]
nodes_num <- c(1:nrow(nodes))
for(n in nodes_num){
  if(nodes[n,4] == "Projekt"){
    nodes[n,8] <- sum(Gdata[(Gdata$proj_id == nodes[n,1]), 17])
  }
}
for(n in nodes_num){
  if(nodes[n,3] %in% abbr$inst){
    nodes[n,2] <- abbr[which(abbr[,2] == nodes[n,3]),1]
  }
}
rm(inst, proj, nodes_num, n)

str(nodes)

links <- Gdata
links <- links[,c(9,6,10,11,7,8,1,2,3,4,5,12,13,14,15,16,17)]
names(links)[c(1,2)] <- c("from", "to")
links_dupl <- links[c("from", "to")]
links <- links[-which(duplicated(links_dupl)),]
rm(links_dupl)

library(igraph)
ntw <- graph_from_data_frame(d = links, vertices = nodes, directed = F)
```

```{r Visualisierung, eval=FALSE}
library(igraph)

V(ntw)$degree <- degree(ntw)
V(ntw)$betweenness <- betweenness(ntw, directed = F)

V(ntw)$plotname <- NA
V(ntw)$plotname[V(ntw)$type == "Institution"] <- nodes$abbr[V(ntw)$type == "Institution"]
#V(ntw)$plotname[as.numeric(V(ntw)$degree[V(ntw)$type == "Institution"]) == 1] <- NA
V(ntw)$vertex.size[V(ntw)$type == "Institution"] <- 3
V(ntw)$vertex.size[V(ntw)$type == "Projekt"] <- 2
  
coul <- RColorBrewer::brewer.pal(5, "YlOrBr")
palette <- as.numeric(V(ntw)$degree[V(ntw)$type == "Institution"])
palette[which(palette == 1)] <- 1
palette[which(palette %in% c(2:5))] <- 2
palette[palette %in% c(6:10)] <- 3
palette[palette %in% c(11:15)] <- 4
palette[palette > 15] <- 5
farben <- coul[palette]

V(ntw)$vertex.label.cex <- 2 * V(ntw)$betweenness / max(V(ntw)$betweenness) + 0.5
V(ntw)$vertex.col[V(ntw)$type == "Institution"] <- farben

#budget <- c("grey90", "dark grey", "black") #"light blue", "cornflowerblue", "dark blue")
#V(ntw)$vertex.frame.col[V(ntw)$budget < 1000000] <- budget[1]
#V(ntw)$vertex.frame.col[V(ntw)$budget >= 1000000] <- budget[2]
#V(ntw)$vertex.frame.col[V(ntw)$budget >= 5000000] <- budget[3]

ressort <- c("grey", "goldenrod4", "forestgreen", "darkorchid")
V(ntw)$vertex.col[V(ntw)$ressort == "BMBF"] <- ressort[1]
V(ntw)$vertex.col[V(ntw)$ressort == "BMEL"] <- ressort[2]
V(ntw)$vertex.col[V(ntw)$ressort == "BMU"] <- ressort[3]
V(ntw)$vertex.col[V(ntw)$ressort == "BMWi"] <- ressort[4]

lyout <- layout.auto(ntw) #layout.fruchterman.reingold(ntw)

plot(ntw, vertex.size = V(ntw)$vertex.size, vertex.color = V(ntw)$vertex.col,
     vertex.label = V(ntw)$plotname, vertex.label.family = "Calibri", vertex.label.cex = V(ntw)$vertex.label.cex,
     vertex.frame.color = "light grey", vertex.label.color = "black",
     edge.arrow.size = 0, edge.color = "gainsboro",
     layout = lyout,
     main = "Projektbasierte Vernetzung in der Biodiversitätsforschung 2019")
legend(-1.6,-0.7, title = "Institution: Degree", legend = c("1", "2-5", "6-10", "11-15", ">15"), fill = coul)
legend(1,-0.7, title = "Projekt: Förderer", legend = c("BMBF", "BMEL", "BMU", "BMWi"), fill = ressort)
#legend(-1.6,1.2, title = "Institution: Degree", legend = c("1", "2-5", "6-10", "11-15", ">15"), fill = coul)
#legend(1,1.2, title = "Projekt: Förderer", legend = c("BMBF", "BMEL", "BMU", "BMWi"), fill = ressort)
#legend(1,-0.5, title = "Budget (Rand)", legend = c("bis 1 Mio Euro", "1-5 Mio Euro", "ab 5 Mio Euro"), fill = budget)
text(0,1.1, "Schriftgröße = Betweenness")

Gdata_sna <- cbind(nodes,
                   degree = V(ntw)$degree,
                   betweenness = V(ntw)$betweenness)
```



