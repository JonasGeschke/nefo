---
title: "Soziale Netzwerkanalyse: Projekte"
author: "Jonas Geschke"
date: "2018"
header-includes:
   - \usepackage{longtable}
output:
  pdf_document:
    toc: yes
  documentclass: article
  html_document:
    toc: yes
  classoption: a4paper
  graphics: yes
---

# Einleitung
Dieses ist das Skript der Netzwerkanalyse zu NeFo auf Grundlage der von DFG und der verschiedenen Bundesressorts geförderten Projekte. Das Skrpit ist verfügbar unter https://github.com/JonasGeschke/nefo
Die Netzwerkanalyse selbst ist verfügbar unter XXX


# Einstellungen

```{r set wd - CHOOSE, eval=FALSE}
# If your working directory is not already specified because you are running this
# script within a project, you will need to use the setwd() function below to set
# the path of your working directory. In order to do this just copy the path
# between the quote signs.
# Please note: The different levels of the path need to be separated by slashes
# ("/"), not by backslashes ("\") which are the windows default.
# 
# setwd("")

#setwd("/Volumes/NO NAME/MfN/Netzwerkanalyse_Projekte/R") # Stick
setwd("Z:/Benutzer/Jonas.Geschke/Netzwerkanalyse_Projekte/R") # Buero
```

```{r install packages, eval=FALSE}
# Installing required packages if not installed yet
if("statnet" %in% rownames(installed.packages())   == FALSE){
  install.packages("statnet")}
if("network" %in% rownames(installed.packages())   == FALSE){
  install.packages("network")}
if("sna" %in% rownames(installed.packages())   == FALSE){
  install.packages("sna")}
if("igraph" %in% rownames(installed.packages())   == FALSE){
  install.packages("igraph")}
if("xts" %in% rownames(installed.packages())   == FALSE){
  install.packages("xts")}
if("xlsx" %in% rownames(installed.packages())   == FALSE){
  install.packages("xlsx")}
if("dplyr" %in% rownames(installed.packages())   == FALSE){
  install.packages("dplyr")}
if("rgl" %in% rownames(installed.packages())   == FALSE){
  install.packages("rgl")}
if("extrafont" %in% rownames(installed.packages())   == FALSE){
  install.packages("extrafont")}
if("circlize" %in% rownames(installed.packages())   == FALSE){
  install.packages("circlize")}
if("RColorBrewer" %in% rownames(installed.packages())   == FALSE){
  install.packages("RColorBrewer")}
```

```{r set additional functions #####EDIT#####, eval=FALSE}
as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}

'%!in%' <- function(x,y)!('%in%'(x,y))

delete.isolates <- function(graph, mode = "all"){
  isolates <- which(degree(graph, mode = mode) == 0)
  delete.vertices(graph, isolates)
}

create_nodes_forschungsnetzwerke_1mode <- function(Gdata){
    w1 <- colnames(Gdata)
    w2 <- rownames(Gdata)
    w3 <- c(paste("net", c(1:ncol(Gdata)), sep = ""))
    w4 <- c(paste("inst", c(1:nrow(Gdata)), sep = ""))
    
    nodes <- as.data.frame(cbind(w4, w2))
    names(nodes) <- c("id", "name")
    nodes$id <- as.character(nodes$id)
    nodes$name <- as.character(nodes$name)
    
    return(nodes)
}

create_links_forschungsnetzwerke_1mode <- function(Gdata){
    w1 <- colnames(Gdata)
    w2 <- rownames(Gdata)
    w3 <- c(paste("net", c(1:ncol(Gdata)), sep = ""))
    w4 <- c(paste("inst", c(1:nrow(Gdata)), sep = ""))
      
    columns_Gdata <- c(1:ncol(Gdata))
    rows_Gdata <- c(1:nrow(Gdata))
    
    links_w <- data.frame(from=character(), to=character(), 
                          network_no=character(), network=character(),
                          stringsAsFactors = FALSE)
     for (c in columns_Gdata){
      for (r in rows_Gdata){
        if (as.numeric(Gdata[r,c]) == 1) {
          links_w <- rbind(links_w,
                           c(w3[c], w4[r], as.numeric(c), colnames(Gdata)[c]), 
                           stringsAsFactors = FALSE)
        } else {}
      }
    }
    
    colnames(links_w) <- c("links_w_1", "links_w_2", "links_w_3", "links_w_4")
    
    links <- data.frame(from=character(), to=character(), 
                        network_no=character(), network=character(),
                        stringsAsFactors = FALSE)
    
    for(n in columns_Gdata){
      subset <- subset(links_w, links_w$links_w_4 == w1[n])
      rowssubset <- c(1:nrow(subset))
      for (r in rowssubset){
        t <- 1
        repeat{
          links <- rbind(links,
                         c(subset[r,2], subset[r+t,2], n, paste(w1[n])),
                         stringsAsFactors = FALSE)
          t <- t+1
          if (t==max(rowssubset)){break}}
      }
    }
    
    colnames(links) <- c("from", "to", "network_no", "network")
    links$network_no <- as.numeric(links$network_no)
    links <- subset(links, !is.na(links$to))
    
    return(links)
}
```


# Analyse

```{r Laden der Rohdaten und Vorbereitung der Daten, eval=FALSE}
library(xlsx)
## Load raw data
Raw_projects_FA <- read.csv2("Daten/Suchergebnisse_FA_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
Raw_projects_FB <- read.csv2("Daten/Suchergebnisse_FB_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
Raw_projects_FC <- read.csv2("Daten/Suchergebnisse_FC_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
Raw_projects_FD <- read.csv2("Daten/Suchergebnisse_FD_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)

projects <- rbind(Raw_projects_FA, Raw_projects_FB, Raw_projects_FC, Raw_projects_FD)
projects <- projects[,-c(1,3,5,7,8,9,10,13,14,15,16)]
projects$inst_id <- NA
projects$proj_id <- NA
projects <- projects[,c(1,2,10,11,16,7,14,15,3,4,5,6,13,9,8,12)]
```

```{r "biodiv" subset, eval=FALSE}
biodiv <- rbind(projects[grep("biodiv", projects$Thema),],
                projects[grep("Biodiv", projects$Thema),],
                projects[grep("biodiv", projects$Verbundprojekt),],
                projects[grep("Biodiv", projects$Verbundprojekt),],
                projects[grep("biodiv", projects$Klartext.Leistungsplansystematik),],
                projects[grep("Biodiv", projects$Klartext.Leistungsplansystematik),])
biodiv <- biodiv[order(biodiv$Ressort, biodiv$PT, biodiv$Verbundprojekt, biodiv$Thema),]
biodiv <- biodiv[-c(which(duplicated(biodiv))),]

inst_ids <- data.frame(unique = unique(biodiv$Zuwendungsempfänger),
                      id = as.character(paste("inst", c(1:length(unique(biodiv$Zuwendungsempfänger))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv))
nrows <- c(1:nrow(inst_ids))
for(n in nrow){
  for (s in nrows){
    if(biodiv[n,9] == inst_ids[s,1]){
       biodiv[n,8] <- inst_ids[s,2]}
    else{}
}}
rm(inst_ids, nrow, nrows, n, s)

biodiv_einzeln <- subset(biodiv, biodiv$Verbundprojekt == "")
biodiv_verbund <- subset(biodiv, biodiv$Verbundprojekt != "")
proj_id <- data.frame(unique = unique(biodiv_verbund$Verbundprojekt),
                      id = as.character(paste("proj", c(1:length(unique(biodiv_verbund$Verbundprojekt))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_verbund))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_verbund[n,7] == proj_id[s,1]){
       biodiv_verbund[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
proj_id <- data.frame(unique = unique(biodiv_einzeln$Thema),
                      id = as.character(
                        paste("proj", 
                              c((length(unique(biodiv_verbund$Verbundprojekt))+1):
                                (length(unique(biodiv_einzeln$Thema))+length(unique(biodiv_verbund$Verbundprojekt)))
                                 ), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_einzeln))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_einzeln[n,6] == proj_id[s,1]){
       biodiv_einzeln[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
biodiv <- rbind(biodiv_verbund, biodiv_einzeln)
rm(biodiv_einzeln, biodiv_verbund)

biodiv$Fördersumme.in.EUR <- as.numeric(biodiv$Fördersumme.in.EUR)
```


# Netzwerkanalyse

```{r Vorbereitung, eval=FALSE}
inst <- data.frame(id = biodiv$inst_id,
                   abbr = NA,
                   name = biodiv$Zuwendungsempfänger,
                   type = "Institution",
                   ressort = NA,
                   pt = NA,
                   leistungsplansystematik = NA,
                   budget = NA,
                   stringsAsFactors = FALSE)
proj <- data.frame(id = biodiv$proj_id,
                   abbr = NA,
                   name = biodiv$Thema,
                   type = "Projekt",
                   ressort = biodiv$Ressort,
                   pt = biodiv$PT,
                   leistungsplansystematik = biodiv$Klartext.Leistungsplansystematik,
                   budget = biodiv$Fördersumme.in.EUR,
                   stringsAsFactors = FALSE)
nodes <- rbind(inst,proj)
rm(inst, proj)
nodes <- nodes[-which(duplicated(nodes$id)),]

str(nodes)

links <- biodiv
links <- links[,c(8,5,9,10,6,7,1,2,3,4,11,12,13,14,15,16)]
names(links)[c(1,2)] <- c("from", "to")

library(igraph)
ntw <- graph_from_data_frame(d = links, vertices = nodes, directed = F)
```

```{r Visualisierung, eval=FALSE}
library(igraph)

V(ntw)$degree <- degree(ntw)
V(ntw)$betweenness <- betweenness(ntw, directed = F)

V(ntw)$plotname <- NA
V(ntw)$plotname[V(ntw)$type == "Institution"] <- nodes$id[nodes$type == "Institution"]

coul <- RColorBrewer::brewer.pal(5, "YlOrBr")
palette <- as.numeric(V(ntw)$degree[V(ntw)$type == "Institution"])
palette[which(palette == 1)] <- 1
palette[which(palette %in% c(2:5))] <- 2
palette[palette %in% c(6:10)] <- 3
palette[palette %in% c(11:15)] <- 4
palette[palette > 15] <- 5
farben <- coul[palette]

V(ntw)$vertex.size <- 5 * V(ntw)$betweenness / max(V(ntw)$betweenness) + 2
V(ntw)$vertex.col[V(ntw)$type == "Institution"] <- farben
#V(ntw)$vertex.col[V(ntw)$ressort == "BMBF"] <- "dark grey"
V(ntw)$vertex.col[V(ntw)$budget < 1000000] <- "light blue"
V(ntw)$vertex.col[V(ntw)$budget >= 1000000] <- "cornflowerblue"
V(ntw)$vertex.col[V(ntw)$budget >= 5000000] <- "dark blue"

lyout <- layout.fruchterman.reingold(ntw)
plot(ntw, vertex.size = V(ntw)$vertex.size, vertex.color = V(ntw)$vertex.col,
     vertex.label = V(ntw)$plotname, vertex.label.family = "Calibri", vertex.label.cex = 0.5,
     vertex.frame.color = NA, vertex.label.color = "black",
     edge.arrow.size = 0, edge.color = "light grey",
     layout = lyout)
```

