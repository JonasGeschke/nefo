---
title: "Soziale Netzwerkanalyse: Projekte"
author: "Jonas Geschke"
date: "2018"
header-includes:
   - \usepackage{longtable}
output:
  pdf_document:
    toc: yes
  documentclass: article
  html_document:
    toc: yes
  classoption: a4paper
  graphics: yes
---

# Einleitung
Dieses ist das Skript der Netzwerkanalyse zu NeFo auf Grundlage der von DFG und der verschiedenen Bundesressorts geförderten Projekte. Das Skrpit ist verfügbar unter https://github.com/JonasGeschke/nefo
Die Netzwerkanalyse selbst ist verfügbar unter XXX


# Einstellungen

```{r set wd - CHOOSE, eval=FALSE}
# If your working directory is not already specified because you are running this
# script within a project, you will need to use the setwd() function below to set
# the path of your working directory. In order to do this just copy the path
# between the quote signs.
# Please note: The different levels of the path need to be separated by slashes
# ("/"), not by backslashes ("\") which are the windows default.
# 
# setwd("")

#setwd("/Volumes/NO NAME/MfN/Netzwerkanalyse_Projekte/R") # Stick
setwd("Z:/Benutzer/Jonas.Geschke/Netzwerkanalyse_Projekte/R") # Buero
```

```{r install packages, eval=FALSE}
# Installing required packages if not installed yet
if("statnet" %in% rownames(installed.packages())   == FALSE){
  install.packages("statnet")}
if("network" %in% rownames(installed.packages())   == FALSE){
  install.packages("network")}
if("sna" %in% rownames(installed.packages())   == FALSE){
  install.packages("sna")}
if("igraph" %in% rownames(installed.packages())   == FALSE){
  install.packages("igraph")}
if("xts" %in% rownames(installed.packages())   == FALSE){
  install.packages("xts")}
if("xlsx" %in% rownames(installed.packages())   == FALSE){
  install.packages("xlsx")}
if("dplyr" %in% rownames(installed.packages())   == FALSE){
  install.packages("dplyr")}
if("rgl" %in% rownames(installed.packages())   == FALSE){
  install.packages("rgl")}
if("extrafont" %in% rownames(installed.packages())   == FALSE){
  install.packages("extrafont")}
if("circlize" %in% rownames(installed.packages())   == FALSE){
  install.packages("circlize")}
if("RColorBrewer" %in% rownames(installed.packages())   == FALSE){
  install.packages("RColorBrewer")}
if("lubridate" %in% rownames(installed.packages())   == FALSE){
  install.packages("lubridate")}
```

```{r set additional functions, eval=FALSE}
as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}

'%!in%' <- function(x,y)!('%in%'(x,y))
```


# Analyse

```{r Laden der Rohdaten und Vorbereitung der Daten: PROJEKTE, eval=FALSE}
library(xlsx)
## Load raw data
#Raw_projects_FA <- read.csv2("Daten/Suchergebnisse_FA_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
#Raw_projects_FB <- read.csv2("Daten/Suchergebnisse_FB_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
#Raw_projects_FC <- read.csv2("Daten/Suchergebnisse_FC_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
#Raw_projects_FD <- read.csv2("Daten/Suchergebnisse_FD_form.csv", sep=";", dec=",", header=T, stringsAsFactors=F)

Raw_projects_gesamt <- read.csv2("Daten/Suchliste_gesamt_form.csv", sep=";", dec=",", header=T, na.strings = "", stringsAsFactors=F) # Abgerufen am 9.1.19

#projects <- rbind(Raw_projects_FA, Raw_projects_FB, Raw_projects_FC, Raw_projects_FD)
projects <- Raw_projects_gesamt

projects <- projects[,-c(1,3,5,7,8,9,10,13,14,15,16)]
projects <- projects[complete.cases(projects[,c(1:3)]),]
projects$inst_id <- NA
projects$proj_id <- NA
projects <- projects[,c(1,2,10,11,16,7,14,15,3,4,5,6,13,9,8,12)]

projects <- projects[order(projects$Ressort, projects$Laufzeit.von, projects$Laufzeit.bis),]

abbr <- read.csv2("Forschungsatlas_abbr.csv", sep=";", dec=",", header=T, stringsAsFactors=F)
```

```{r "biodiv" subset, eval=FALSE}
biodiv <- rbind(projects[grep("biodiv", projects$Thema),],
                projects[grep("Biodiv", projects$Thema),],
                projects[grep("biodiv", projects$Verbundprojekt),],
                projects[grep("Biodiv", projects$Verbundprojekt),],
                projects[grep("biodiv", projects$Klartext.Leistungsplansystematik),],
                projects[grep("Biodiv", projects$Klartext.Leistungsplansystematik),])
biodiv <- biodiv[order(biodiv$Ressort, 
                       strptime(biodiv$Laufzeit.von,format="%d.%m.%Y"), 
                       biodiv$Verbundprojekt, 
                       biodiv$Thema),]
biodiv <- biodiv[-c(which(duplicated(biodiv))),]

inst_ids <- data.frame(unique = unique(biodiv$Zuwendungsempfänger),
                      id = as.character(paste("inst", c(1:length(unique(biodiv$Zuwendungsempfänger))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv))
nrows <- c(1:nrow(inst_ids))
for(n in nrow){
  for (s in nrows){
    if(biodiv[n,9] == inst_ids[s,1]){
       biodiv[n,8] <- inst_ids[s,2]}
    else{}
}}
rm(inst_ids, nrow, nrows, n, s)

biodiv_einzeln <- subset(biodiv, is.na(biodiv$Verbundprojekt))
biodiv_verbund <- subset(biodiv, !is.na(biodiv$Verbundprojekt))
biodiv_einzeln$unique <- paste(biodiv_einzeln$Laufzeit.von, biodiv_einzeln$Thema, sep = "_")
biodiv_verbund$unique <- paste(biodiv_verbund$Laufzeit.von, biodiv_verbund$Verbundprojekt, sep = "_")
proj_id <- data.frame(unique = unique(biodiv_verbund$unique),
                      id = as.character(paste("proj", c(1:length(unique(biodiv_verbund$unique))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_verbund))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_verbund[n,17] == proj_id[s,1]){
       biodiv_verbund[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
proj_id <- data.frame(unique = unique(biodiv_einzeln$unique),
                      id = as.character(
                        paste("proj", 
                              c((length(unique(biodiv_verbund$unique))+1):
                                (length(unique(biodiv_einzeln$unique))+length(unique(biodiv_verbund$unique)))
                                 ), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_einzeln))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_einzeln[n,17] == proj_id[s,1]){
       biodiv_einzeln[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
biodiv <- rbind(biodiv_verbund, biodiv_einzeln)
rm(biodiv_einzeln, biodiv_verbund)
biodiv <- biodiv[,-17]
```
```{r "biodiv" +/ "ökosystem" subset, eval=FALSE}
biodivoecosystem <- rbind(projects[grep("biodiv", projects$Thema),],
                projects[grep("Biodiv", projects$Thema),],
                projects[grep("biodiv", projects$Verbundprojekt),],
                projects[grep("Biodiv", projects$Verbundprojekt),],
                projects[grep("biodiv", projects$Klartext.Leistungsplansystematik),],
                projects[grep("Biodiv", projects$Klartext.Leistungsplansystematik),],
                projects[grep("ökosystem", projects$Thema),],
                projects[grep("Ökosystem", projects$Thema),],
                projects[grep("ökosystem", projects$Verbundprojekt),],
                projects[grep("Ökosystem", projects$Verbundprojekt),],
                projects[grep("ökosystem", projects$Klartext.Leistungsplansystematik),],
                projects[grep("Ökosystem", projects$Klartext.Leistungsplansystematik),])
biodivoecosystem <- biodivoecosystem[order(biodivoecosystem$Ressort, 
                                           biodivoecosystem$PT, 
                                           biodivoecosystem$Verbundprojekt, 
                                           biodivoecosystem$Thema),]
biodivoecosystem <- biodivoecosystem[-c(which(duplicated(biodivoecosystem))),]

inst_ids <- data.frame(unique = unique(biodivoecosystem$Zuwendungsempfänger),
                      id = as.character(paste("inst", c(1:length(unique(biodivoecosystem$Zuwendungsempfänger))), 
                                              sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodivoecosystem))
nrows <- c(1:nrow(inst_ids))
for(n in nrow){
  for (s in nrows){
    if(biodivoecosystem[n,9] == inst_ids[s,1]){
       biodivoecosystem[n,8] <- inst_ids[s,2]}
    else{}
}}
rm(inst_ids, nrow, nrows, n, s)

biodiv_einzeln <- subset(biodivoecosystem, biodivoecosystem$Verbundprojekt == "")
biodiv_verbund <- subset(biodivoecosystem, biodivoecosystem$Verbundprojekt != "")
proj_id <- data.frame(unique = unique(biodiv_verbund$Verbundprojekt),
                      id = as.character(paste("proj", c(1:length(unique(biodiv_verbund$Verbundprojekt))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_verbund))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_verbund[n,7] == proj_id[s,1]){
       biodiv_verbund[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
proj_id <- data.frame(unique = unique(biodiv_einzeln$Thema),
                      id = as.character(
                        paste("proj", 
                              c((length(unique(biodiv_verbund$Verbundprojekt))+1):
                                (length(unique(biodiv_einzeln$Thema))+length(unique(biodiv_verbund$Verbundprojekt)))
                                 ), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_einzeln))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_einzeln[n,6] == proj_id[s,1]){
       biodiv_einzeln[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
biodivoecosystem <- rbind(biodiv_verbund, biodiv_einzeln)
rm(biodiv_einzeln, biodiv_verbund)
```
```{r "ökosystem" subset, eval=FALSE}
oekosystem <- rbind(projects[grep("ökosystem", projects$Thema),],
                projects[grep("Ökosystem", projects$Thema),],
                projects[grep("ökosystem", projects$Verbundprojekt),],
                projects[grep("Ökosystem", projects$Verbundprojekt),],
                projects[grep("ökosystem", projects$Klartext.Leistungsplansystematik),],
                projects[grep("Ökosystem", projects$Klartext.Leistungsplansystematik),])
oekosystem <- oekosystem[order(oekosystem$Ressort, oekosystem$PT, oekosystem$Verbundprojekt, oekosystem$Thema),]
oekosystem <- oekosystem[-c(which(duplicated(oekosystem))),]

inst_ids <- data.frame(unique = unique(oekosystem$Zuwendungsempfänger),
                      id = as.character(paste("inst", c(1:length(unique(oekosystem$Zuwendungsempfänger))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(oekosystem))
nrows <- c(1:nrow(inst_ids))
for(n in nrow){
  for (s in nrows){
    if(oekosystem[n,9] == inst_ids[s,1]){
       oekosystem[n,8] <- inst_ids[s,2]}
    else{}
}}
rm(inst_ids, nrow, nrows, n, s)

biodiv_einzeln <- subset(oekosystem, oekosystem$Verbundprojekt == "")
biodiv_verbund <- subset(oekosystem, oekosystem$Verbundprojekt != "")
proj_id <- data.frame(unique = unique(biodiv_verbund$Verbundprojekt),
                      id = as.character(paste("proj", c(1:length(unique(biodiv_verbund$Verbundprojekt))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_verbund))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_verbund[n,7] == proj_id[s,1]){
       biodiv_verbund[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
proj_id <- data.frame(unique = unique(biodiv_einzeln$Thema),
                      id = as.character(
                        paste("proj", 
                              c((length(unique(biodiv_verbund$Verbundprojekt))+1):
                                (length(unique(biodiv_einzeln$Thema))+length(unique(biodiv_verbund$Verbundprojekt)))
                                 ), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_einzeln))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_einzeln[n,6] == proj_id[s,1]){
       biodiv_einzeln[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
oekosystem <- rbind(biodiv_verbund, biodiv_einzeln)
rm(biodiv_einzeln, biodiv_verbund)
```
```{r "biodiv" +/ "biologische(n) Vielfalt" subset, eval=FALSE}
biodivbiolvielfalt <- rbind(projects[grep("biodiv", projects$Thema),],
                projects[grep("Biodiv", projects$Thema),],
                projects[grep("biodiv", projects$Verbundprojekt),],
                projects[grep("Biodiv", projects$Verbundprojekt),],
                projects[grep("biodiv", projects$Klartext.Leistungsplansystematik),],
                projects[grep("Biodiv", projects$Klartext.Leistungsplansystematik),],
                projects[grep("biologische Vielfalt", projects$Thema),],
                projects[grep("biologischen Vielfalt", projects$Thema),],
                projects[grep("biologische Vielfalt", projects$Verbundprojekt),],
                projects[grep("biologischen Vielfalt", projects$Verbundprojekt),],
                projects[grep("biologische Vielfalt", projects$Klartext.Leistungsplansystematik),],
                projects[grep("biologischen Vielfalt", projects$Klartext.Leistungsplansystematik),])
biodivbiolvielfalt <- biodivbiolvielfalt[order(biodivbiolvielfalt$Ressort, 
                                           biodivbiolvielfalt$PT, 
                                           biodivbiolvielfalt$Verbundprojekt, 
                                           biodivbiolvielfalt$Thema),]
biodivbiolvielfalt <- biodivbiolvielfalt[-c(which(duplicated(biodivbiolvielfalt))),]

inst_ids <- data.frame(unique = unique(biodivbiolvielfalt$Zuwendungsempfänger),
                      id = as.character(paste("inst", c(1:length(unique(biodivbiolvielfalt$Zuwendungsempfänger))), 
                                              sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodivbiolvielfalt))
nrows <- c(1:nrow(inst_ids))
for(n in nrow){
  for (s in nrows){
    if(biodivbiolvielfalt[n,9] == inst_ids[s,1]){
       biodivbiolvielfalt[n,8] <- inst_ids[s,2]}
    else{}
}}
rm(inst_ids, nrow, nrows, n, s)

biodiv_einzeln <- subset(biodivbiolvielfalt, biodivbiolvielfalt$Verbundprojekt == "")
biodiv_verbund <- subset(biodivbiolvielfalt, biodivbiolvielfalt$Verbundprojekt != "")
proj_id <- data.frame(unique = unique(biodiv_verbund$Verbundprojekt),
                      id = as.character(paste("proj", c(1:length(unique(biodiv_verbund$Verbundprojekt))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_verbund))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_verbund[n,7] == proj_id[s,1]){
       biodiv_verbund[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
proj_id <- data.frame(unique = unique(biodiv_einzeln$Thema),
                      id = as.character(
                        paste("proj", 
                              c((length(unique(biodiv_verbund$Verbundprojekt))+1):
                                (length(unique(biodiv_einzeln$Thema))+length(unique(biodiv_verbund$Verbundprojekt)))
                                 ), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_einzeln))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_einzeln[n,6] == proj_id[s,1]){
       biodiv_einzeln[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
biodivbiolvielfalt <- rbind(biodiv_verbund, biodiv_einzeln)
rm(biodiv_einzeln, biodiv_verbund)
```

```{r "biodiv"-inst subset # MACHT KEINEN SINN, eval=FALSE}
biodivinst <- rbind(projects[grep("biodiv", projects$Thema),],
                projects[grep("Biodiv", projects$Thema),],
                projects[grep("biodiv", projects$Verbundprojekt),],
                projects[grep("Biodiv", projects$Verbundprojekt),],
                projects[grep("biodiv", projects$Klartext.Leistungsplansystematik),],
                projects[grep("Biodiv", projects$Klartext.Leistungsplansystematik),])
biodivinst <- biodivinst[order(biodivinst$Ressort, biodivinst$PT, biodivinst$Verbundprojekt, biodivinst$Thema),]
biodivinst <- biodivinst[-c(which(duplicated(biodivinst))),]

inst_ids <- data.frame(unique = unique(biodivinst$Zuwendungsempfänger),
                      id = as.character(paste("inst", c(1:length(unique(biodivinst$Zuwendungsempfänger))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodivinst))
nrows <- c(1:nrow(inst_ids))
for(n in nrow){
  for (s in nrows){
    if(biodivinst[n,9] == inst_ids[s,1]){
       biodivinst[n,8] <- inst_ids[s,2]}
    else{}
}}
rm(nrow, nrows, n, s)

biodivinst_work <- projects[grep(inst_ids[1,1], projects$Zuwendungsempfänger),]
inst_ids_num <- c(2:nrow(inst_ids))
for(i in inst_ids_num){
  biodivinst_work <- rbind(biodivinst_work, projects[grep(inst_ids[i,1], projects$Zuwendungsempfänger),])
}
rm(inst_ids_num, i)

nrow <- c(1:nrow(biodivinst_work))
nrows <- c(1:nrow(inst_ids))
for(n in nrow){
  for (s in nrows){
    if(biodivinst_work[n,9] == inst_ids[s,1]){
       biodivinst_work[n,8] <- inst_ids[s,2]}
    else{}
}}
rm(nrow, nrows, n, s)

biodiv_einzeln <- subset(biodivinst_work, biodivinst_work$Verbundprojekt == "")
biodiv_verbund <- subset(biodivinst_work, biodivinst_work$Verbundprojekt != "")
proj_id <- data.frame(unique = unique(biodiv_verbund$Verbundprojekt),
                      id = as.character(paste("proj", c(1:length(unique(biodiv_verbund$Verbundprojekt))), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_verbund))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_verbund[n,7] == proj_id[s,1]){
       biodiv_verbund[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
proj_id <- data.frame(unique = unique(biodiv_einzeln$Thema),
                      id = as.character(
                        paste("proj", 
                              c((length(unique(biodiv_verbund$Verbundprojekt))+1):
                                (length(unique(biodiv_einzeln$Thema))+length(unique(biodiv_verbund$Verbundprojekt)))
                                 ), sep = "")), 
                      stringsAsFactors = FALSE)
nrow <- c(1:nrow(biodiv_einzeln))
nrows <- c(1:nrow(proj_id))
for(n in nrow){
  for (s in nrows){
    if(biodiv_einzeln[n,6] == proj_id[s,1]){
       biodiv_einzeln[n,5] <- proj_id[s,2]}
    else{}
}}
rm(proj_id, nrow, nrows, n, s)
biodivinst <- rbind(biodiv_verbund, biodiv_einzeln)
rm(biodiv_einzeln, biodiv_verbund, biodivinst_work)
```


# Ergänzung durch Forschungsverbünde

```{r Laden der Rohdaten und Vorbereitung der Daten, eval=FALSE}
## Load raw data
Raw_forschungsnetzwerke <- read.csv2("Daten/forschungsnetzwerk.csv", sep=",", dec=".", header=T, encoding="UTF-8")

## Prepare dataset "FN"
Gdata_FN <- Raw_forschungsnetzwerke
names(Gdata_FN) <- c("inst", "abbr", "BeGenDiv", "BBIB", "BioFrankfurt", "BION", "iDiv", "Ecornet", "FVB", "GBIF-D", "GFBIO", "HIFMB", "KDM", "LVB")
Gdata_FN <- Gdata_FN[,-c(7,9,10,11)] #Delete iDiv, FVB, GBIF-D, GFBIO
rownames(Gdata_FN) <- Gdata_FN[,2] #Inst oder abbr as rownames
Gdata_FN <- Gdata_FN[,-c(1,2)] #Delete inst and abbr
Gdata_FN <- Gdata_FN[,c(8,4,2,7,3,5,1,6)] #Order by number of members

Gdata_FN$BeGenDiv <- as.numeric(Gdata_FN$BeGenDiv)
Gdata_FN$BBIB <- as.numeric(Gdata_FN$BBIB) #raus?
Gdata_FN$BioFrankfurt <- as.numeric(Gdata_FN$BioFrankfurt)
Gdata_FN$BION <- as.numeric(Gdata_FN$BION)
Gdata_FN$iDiv <- as.numeric(Gdata_FN$iDiv) #raus
Gdata_FN$Ecornet <- as.numeric(Gdata_FN$Ecornet)
Gdata_FN$GFBIO <- as.numeric(Gdata_FN$GFBIO) #raus
Gdata_FN$HIFMB <- as.numeric(Gdata_FN$HIFMB)
Gdata_FN$KDM <- as.numeric(Gdata_FN$KDM)
Gdata_FN$LVB <- as.numeric(Gdata_FN$LVB)
Gdata_FN$`GBIF-D` <- as.numeric(Gdata_FN$`GBIF-D`) #raus
```


# Netzwerkanalyse

```{r Auswahl Datensatz, eval=FALSE}
Gdata <- biodiv
Gdata <- biodivoecosystem
Gdata <- oecosystem
Gdata <- biodivbiolvielfalt

```

```{r Auswahl Förderzeitraum, eval=FALSE}
Gdata$Förderjahre <- NA
Gdata <- Gdata[,c(1:2,17,3:16)]

#Gdata$calc <- paste(as.numeric(format(as.Date(Gdata$Laufzeit.von, "%d.%m.%Y"), "%Y")), " - ",
#                              as.numeric(format(as.Date(Gdata$Laufzeit.bis, "%d.%m.%Y"), "%Y")))

years <- c(as.numeric(format(as.Date(Gdata$Laufzeit.bis, "%d.%m.%Y"), "%Y")) - 
             as.numeric(format(as.Date(Gdata$Laufzeit.von, "%d.%m.%Y"), "%Y")))
nrow <- c(1:nrow(Gdata))

for(n in nrow){
  p <- 1
  period <- c(seq(from = as.numeric(format(as.Date(Gdata[n,4], "%d.%m.%Y"), "%Y")), 
                        length.out = (years[n]+1)))
  period_num <- c(1:length(period))
  Gdata[n,3] <- paste(period, collapse = "/")
}
rm(years, nrow, n, p, period, period_num)

Gdata <- Gdata[grep("2019", Gdata$Förderjahre),]

```

```{r Vorbereitung, eval=FALSE}
inst <- data.frame(id = Gdata$inst_id,
                   abbr = NA,
                   name = Gdata$Zuwendungsempfänger,
                   type = "Institution",
                   ressort = NA,
                   pt = NA,
                   leistungsplansystematik = NA,
                   budget = NA,
                   stringsAsFactors = FALSE)
proj <- data.frame(id = Gdata$proj_id,
                   abbr = NA,
                   name = Gdata$Thema,
                   type = "Projekt",
                   ressort = Gdata$Ressort,
                   pt = Gdata$PT,
                   leistungsplansystematik = Gdata$Klartext.Leistungsplansystematik,
                   budget = NA,
                   stringsAsFactors = FALSE)
nodes <- rbind(inst,proj)
nodes <- nodes[-which(duplicated(nodes$id)),]
nodes_num <- c(1:nrow(nodes))
for(n in nodes_num){
  if(nodes[n,4] == "Projekt"){
    nodes[n,8] <- sum(Gdata[(Gdata$proj_id == nodes[n,1]), 17])
  }
}
for(n in nodes_num){
  if(nodes[n,3] %in% abbr$inst){
    nodes[n,2] <- abbr[which(abbr[,2] == nodes[n,3]),3]
  }
}
rm(inst, proj, nodes_num, n)

str(nodes)

links <- Gdata
links <- links[,c(9,6,10,11,7,8,1,2,3,4,5,12,13,14,15,16,17)]
names(links)[c(1,2)] <- c("from", "to")
links_dupl <- links[c("from", "to")]
links <- links[-which(duplicated(links_dupl)),]
rm(links_dupl)

library(igraph)
ntw <- graph_from_data_frame(d = links, vertices = nodes, directed = F)
```

```{r Visualisierung, eval=FALSE}
library(igraph)

V(ntw)$degree <- degree(ntw)
V(ntw)$betweenness <- betweenness(ntw, directed = F)

V(ntw)$plotname <- NA
V(ntw)$plotname[V(ntw)$type == "Institution"] <- nodes$id[V(ntw)$type == "Institution"]
#V(ntw)$vertex.size[V(ntw)$type == "Institution"] <- 
#V(ntw)$vertex.size[V(ntw)$type == "Projekt"] <- 
  
coul <- RColorBrewer::brewer.pal(5, "YlOrBr")
palette <- as.numeric(V(ntw)$degree[V(ntw)$type == "Institution"])
palette[which(palette == 1)] <- 1
palette[which(palette %in% c(2:5))] <- 2
palette[palette %in% c(6:10)] <- 3
palette[palette %in% c(11:15)] <- 4
palette[palette > 15] <- 5
farben <- coul[palette]

V(ntw)$vertex.label.cex <- 2 * V(ntw)$betweenness / max(V(ntw)$betweenness) + 0.5
V(ntw)$vertex.col[V(ntw)$type == "Institution"] <- farben

budget <- c("grey90", "dark grey", "black") #"light blue", "cornflowerblue", "dark blue")
V(ntw)$vertex.frame.col[V(ntw)$budget < 1000000] <- budget[1]
V(ntw)$vertex.frame.col[V(ntw)$budget >= 1000000] <- budget[2]
V(ntw)$vertex.frame.col[V(ntw)$budget >= 5000000] <- budget[3]

ressort <- c("grey", "goldenrod4", "forestgreen", "darkorchid")
V(ntw)$vertex.col[V(ntw)$ressort == "BMBF"] <- ressort[1]
V(ntw)$vertex.col[V(ntw)$ressort == "BMEL"] <- ressort[2]
V(ntw)$vertex.col[V(ntw)$ressort == "BMU"] <- ressort[3]
V(ntw)$vertex.col[V(ntw)$ressort == "BMWi"] <- ressort[4]

lyout <- layout.auto(ntw) #layout.fruchterman.reingold(ntw)
plot(ntw, vertex.size = 3, vertex.color = V(ntw)$vertex.col,
     vertex.label = V(ntw)$plotname, vertex.label.family = "Calibri", vertex.label.cex = V(ntw)$vertex.label.cex,
     vertex.frame.color = V(ntw)$vertex.frame.col, vertex.label.color = "black",
     edge.arrow.size = 0, edge.color = "gainsboro",
     layout = lyout,
     main = "Titel")
legend(-1.6,1.2, title = "Institution: Degree", legend = c("1", "2-5", "6-10", "11-15", ">15"), fill = coul)
legend(1,1.2, title = "Förderer", legend = c("BMBF", "BMEL", "BMU", "BMWi"), fill = ressort)
legend(1,-0.5, title = "Budget (Rand)", legend = c("bis 1 Mio Euro", "1-5 Mio Euro", "ab 5 Mio Euro"), fill = budget)
text(0,1.1, "Schriftgröße = Betweenness")

Gdata_sna <- cbind(nodes,
                   degree = V(ntw)$degree,
                   betweenness = V(ntw)$betweenness)
```



